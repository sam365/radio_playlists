---
  version: 2
  jobs:
    build:
      working_directory: ~/radio_playlists
      docker:
        - image: circleci/ruby:2.6.5
          environment:
            PGHOST: localhost
            PGUSER: radio_playlists
            RAILS_ENV: test
        - image: postgres:latest
          environment:
            POSTGRES_USER: radio_playlists
            POSTGRES_DB: radio_playlists_test
            POSTGRES_PASSWORD: "Super-C0mpl3X"
      steps:
        - checkout
  
        # Restore Cached Dependencies
        - type: cache-restore
          name: Restore bundle cache
          key: radio_playlists-{{ checksum "Gemfile.lock" }}
  
        # Bundle install dependencies
        - run: bundle install --path vendor/bundle
  
        # Cache Dependencies
        - type: cache-save
          name: Store bundle cache
          key: radio_playlists-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
  
        # Wait for DB
        - run: dockerize -wait tcp://localhost:5432 -timeout 1m
  
        # Setup the environment
        - run: cp .env.test .env
  
        # Setup the database
        - run: bundle exec rake db:test:prepare
  
        # Run the tests
        - run: bundle exec rspec